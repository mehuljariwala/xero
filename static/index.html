<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Xero Command Center</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-deepest: #f8fafc;
      --bg-deep: #ffffff;
      --bg-card: #f1f5f9;
      --bg-card-hover: #e2e8f0;
      --bg-elevated: #cbd5e1;

      --border-subtle: rgba(100, 116, 139, 0.15);
      --border-medium: rgba(100, 116, 139, 0.25);

      --text-primary: #0f172a;
      --text-secondary: #475569;
      --text-muted: #94a3b8;

      --accent-emerald: #059669;
      --accent-emerald-dim: rgba(5, 150, 105, 0.12);
      --accent-amber: #d97706;
      --accent-amber-dim: rgba(217, 119, 6, 0.12);
      --accent-rose: #dc2626;
      --accent-rose-dim: rgba(220, 38, 38, 0.1);
      --accent-sky: #0284c7;
      --accent-sky-dim: rgba(2, 132, 199, 0.1);
      --accent-violet: #7c3aed;
      --accent-violet-dim: rgba(124, 58, 237, 0.1);

      --glass: rgba(255, 255, 255, 0.8);
      --glass-border: rgba(100, 116, 139, 0.1);

      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;

      --shadow-glow: 0 0 60px rgba(5, 150, 105, 0.08);
      --shadow-card: 0 4px 24px rgba(0, 0, 0, 0.06);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-deepest);
      color: var(--text-primary);
      min-height: 100vh;
      overflow: hidden;
    }

    /* Subtle grid background */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(rgba(5, 150, 105, 0.04) 1px, transparent 1px),
        linear-gradient(90deg, rgba(5, 150, 105, 0.04) 1px, transparent 1px);
      background-size: 60px 60px;
      pointer-events: none;
      z-index: 0;
    }

    /* Gradient orbs */
    .orb {
      position: fixed;
      border-radius: 50%;
      filter: blur(120px);
      pointer-events: none;
      z-index: 0;
    }
    .orb-1 {
      width: 600px;
      height: 600px;
      background: radial-gradient(circle, rgba(5, 150, 105, 0.12) 0%, transparent 70%);
      top: -200px;
      left: -200px;
    }
    .orb-2 {
      width: 500px;
      height: 500px;
      background: radial-gradient(circle, rgba(124, 58, 237, 0.08) 0%, transparent 70%);
      bottom: -150px;
      right: -150px;
    }

    .app {
      display: grid;
      grid-template-rows: auto 1fr;
      height: 100vh;
      position: relative;
      z-index: 1;
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      background: var(--glass);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border-subtle);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .brand-icon {
      width: 42px;
      height: 42px;
      background: linear-gradient(135deg, var(--accent-emerald), #059669);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
    }

    .brand-icon svg {
      width: 24px;
      height: 24px;
      color: white;
    }

    .brand-text h1 {
      font-size: 1.25rem;
      font-weight: 600;
      letter-spacing: -0.02em;
    }

    .brand-text span {
      font-size: 0.75rem;
      color: var(--text-muted);
      font-weight: 400;
    }

    .header-status {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .status-pill {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: 100px;
      font-size: 0.875rem;
      font-weight: 500;
    }

    .status-pill.running {
      background: var(--accent-emerald-dim);
      border-color: var(--accent-emerald);
    }

    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-muted);
    }

    .status-indicator.active {
      background: var(--accent-emerald);
      box-shadow: 0 0 12px var(--accent-emerald);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.1); }
    }

    /* Main Layout - 3 Panels + Resize Handle */
    .main {
      display: grid;
      grid-template-columns: 320px 1fr 6px 380px;
      gap: 1px;
      background: var(--border-subtle);
      overflow: hidden;
    }

    .resize-handle {
      background: var(--bg-deep);
      cursor: col-resize;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      z-index: 10;
    }

    .resize-handle::after {
      content: '';
      width: 2px;
      height: 32px;
      border-radius: 1px;
      background: transparent;
      transition: background 0.2s ease;
    }

    .resize-handle:hover::after,
    .resize-handle.dragging::after {
      background: var(--accent-emerald);
    }

    .resize-handle:hover,
    .resize-handle.dragging {
      background: var(--border-subtle);
    }

    .panel {
      background: var(--bg-deep);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .panel-header {
      padding: 20px;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .panel-title {
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
    }

    .panel-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .panel-content::-webkit-scrollbar {
      width: 6px;
    }

    .panel-content::-webkit-scrollbar-track {
      background: transparent;
    }

    .panel-content::-webkit-scrollbar-thumb {
      background: var(--bg-elevated);
      border-radius: 3px;
    }

    /* Left Panel - Clients */
    .upload-zone {
      border: 2px dashed var(--border-medium);
      border-radius: var(--radius-lg);
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 16px;
      background: var(--bg-card);
    }

    .upload-zone:hover, .upload-zone.dragover {
      border-color: var(--accent-emerald);
      background: var(--accent-emerald-dim);
    }

    .upload-zone svg {
      width: 40px;
      height: 40px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .upload-zone h4 {
      font-size: 0.9rem;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .upload-zone p {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .upload-zone input {
      display: none;
    }

    .file-loaded {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--accent-emerald-dim);
      border: 1px solid var(--accent-emerald);
      border-radius: var(--radius-md);
      margin-bottom: 16px;
    }

    .file-loaded svg {
      width: 20px;
      height: 20px;
      color: var(--accent-emerald);
    }

    .file-loaded span {
      flex: 1;
      font-size: 0.85rem;
      font-weight: 500;
    }

    .file-loaded button {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
    }

    .file-loaded button:hover {
      color: var(--accent-rose);
    }

    .client-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .client-item {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      overflow: hidden;
      transition: all 0.2s ease;
    }

    .client-item:hover {
      border-color: var(--border-medium);
    }

    .client-item.selected {
      border-color: var(--accent-emerald);
      background: var(--accent-emerald-dim);
    }

    .client-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      cursor: pointer;
    }

    .client-checkbox {
      appearance: none;
      width: 18px;
      height: 18px;
      border: 2px solid var(--border-medium);
      border-radius: 4px;
      cursor: pointer;
      position: relative;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .client-checkbox:checked {
      background: var(--accent-emerald);
      border-color: var(--accent-emerald);
    }

    .client-checkbox:checked::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 5px;
      width: 4px;
      height: 8px;
      border: solid white;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
    }

    .client-avatar {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-sm);
      background: linear-gradient(135deg, var(--accent-violet), var(--accent-sky));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 600;
      flex-shrink: 0;
      color: white;
    }

    .client-info {
      flex: 1;
      min-width: 0;
    }

    .client-name {
      font-size: 0.9rem;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .client-meta {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .client-expand {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      transition: transform 0.2s ease;
    }

    .client-expand.expanded {
      transform: rotate(180deg);
    }

    .client-reports {
      display: none;
      padding: 0 16px 14px;
      gap: 6px;
      flex-direction: column;
    }

    .client-reports.visible {
      display: flex;
    }

    .report-toggle-all {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      margin-bottom: 6px;
      background: none;
      border: 1px solid var(--border-subtle);
      border-radius: 6px;
      font-family: 'Outfit', sans-serif;
      font-size: 0.7rem;
      font-weight: 500;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s ease;
      width: fit-content;
    }

    .report-toggle-all:hover {
      border-color: var(--accent-emerald);
      color: var(--accent-emerald);
      background: var(--accent-emerald-dim);
    }

    .report-toggle-all svg {
      width: 12px;
      height: 12px;
      flex-shrink: 0;
    }

    .report-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--bg-deep);
      border-radius: var(--radius-sm);
      font-size: 0.8rem;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .report-item:hover {
      background: var(--bg-card-hover);
      color: var(--text-primary);
    }

    .report-item input {
      appearance: none;
      width: 14px;
      height: 14px;
      border: 2px solid var(--border-medium);
      border-radius: 3px;
      cursor: pointer;
      position: relative;
    }

    .report-item input:checked {
      background: var(--accent-emerald);
      border-color: var(--accent-emerald);
    }

    .report-item input:checked::after {
      content: '';
      position: absolute;
      top: 1px;
      left: 4px;
      width: 3px;
      height: 6px;
      border: solid white;
      border-width: 0 1.5px 1.5px 0;
      transform: rotate(45deg);
    }

    /* Action Buttons */
    .action-bar {
      padding: 16px;
      border-top: 1px solid var(--border-subtle);
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: var(--bg-deep);
    }

    .btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 14px 20px;
      border: none;
      border-radius: var(--radius-md);
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-emerald), #059669);
      color: white;
      box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 30px rgba(16, 185, 129, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-danger {
      background: var(--accent-rose);
      color: white;
    }

    .btn-danger:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .btn svg {
      width: 18px;
      height: 18px;
    }

    /* Middle Panel Layout */
    .middle-panel {
      display: flex;
      flex-direction: column;
      padding: 0;
    }

    .browser-section {
      display: none;
    }

    .activity-section {
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
      border-top: none;
    }

    .section-header {
      padding: 14px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border-subtle);
      background: var(--bg-deep);
      position: sticky;
      top: 0;
      z-index: 5;
      flex-shrink: 0;
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .section-title svg { color: var(--accent-emerald); }

    .log-count-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 20px;
      height: 20px;
      padding: 0 6px;
      background: var(--accent-emerald-dim);
      border: 1px solid rgba(5, 150, 105, 0.2);
      border-radius: 100px;
      font-size: 0.65rem;
      font-weight: 700;
      color: var(--accent-emerald);
      font-family: 'JetBrains Mono', monospace;
    }

    .section-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .activity-content {
      flex: 1;
      overflow-y: auto;
      padding: 12px 16px;
      scroll-behavior: smooth;
    }

    .activity-content::-webkit-scrollbar { width: 4px; }
    .activity-content::-webkit-scrollbar-track { background: transparent; }
    .activity-content::-webkit-scrollbar-thumb { background: var(--bg-elevated); border-radius: 2px; }

    .activity-feed {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .activity-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      min-height: 300px;
      gap: 16px;
    }

    .empty-state-icon {
      width: 64px;
      height: 64px;
      border-radius: var(--radius-lg);
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
    }

    .empty-state-icon svg { width: 28px; height: 28px; opacity: 0.5; }

    .empty-state-text { text-align: center; }
    .empty-state-text p { font-size: 0.9rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 4px; }
    .empty-state-text span { font-size: 0.75rem; color: var(--text-muted); }

    @keyframes cardEnter {
      from { opacity: 0; transform: translateY(-4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Log entry - compact inline row */
    .log-entry {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 7px 12px;
      border-radius: 6px;
      animation: cardEnter 0.15s ease forwards;
      transition: background 0.15s ease;
    }

    .log-entry:hover { background: var(--bg-card); }

    .log-entry .log-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      flex-shrink: 0;
      margin-top: 5px;
    }

    .log-entry.level-info .log-dot { background: var(--accent-sky); }
    .log-entry.level-success .log-dot { background: var(--accent-emerald); box-shadow: 0 0 6px rgba(5, 150, 105, 0.4); }
    .log-entry.level-warning .log-dot { background: var(--accent-amber); box-shadow: 0 0 6px rgba(217, 119, 6, 0.4); }
    .log-entry.level-error .log-dot { background: var(--accent-rose); box-shadow: 0 0 6px rgba(220, 38, 38, 0.4); }

    .log-entry .log-text {
      flex: 1;
      font-size: 0.8rem;
      line-height: 1.5;
      color: var(--text-secondary);
      word-break: break-word;
    }

    .log-entry.level-success .log-text { color: var(--accent-emerald); font-weight: 500; }
    .log-entry.level-warning .log-text { color: var(--accent-amber); }
    .log-entry.level-error .log-text { color: var(--accent-rose); font-weight: 500; }

    .log-entry .log-time {
      font-size: 0.6rem;
      color: var(--text-muted);
      font-family: 'JetBrains Mono', monospace;
      flex-shrink: 0;
      padding-top: 2px;
      opacity: 0.6;
    }

    .log-entry:hover .log-time { opacity: 1; }

    .log-entry .log-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
    }

    .log-entry .log-chip {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      padding: 1px 6px;
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: 3px;
      font-size: 0.6rem;
      font-family: 'JetBrains Mono', monospace;
      color: var(--text-secondary);
    }

    .log-chip-key { color: var(--text-muted); }

    /* Banner cards for milestones */
    .log-banner {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: var(--radius-sm);
      margin: 6px 0;
      animation: cardEnter 0.2s ease forwards;
    }

    .log-banner .banner-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .log-banner .banner-icon svg { width: 16px; height: 16px; }

    .log-banner .banner-body { flex: 1; min-width: 0; }

    .log-banner .banner-title {
      font-size: 0.82rem;
      font-weight: 600;
      line-height: 1.3;
    }

    .log-banner .banner-sub {
      font-size: 0.7rem;
      opacity: 0.7;
      margin-top: 2px;
    }

    .log-banner .banner-time {
      font-size: 0.6rem;
      font-family: 'JetBrains Mono', monospace;
      opacity: 0.5;
      flex-shrink: 0;
    }

    .log-banner.banner-start {
      background: linear-gradient(135deg, rgba(2, 132, 199, 0.08), rgba(124, 58, 237, 0.06));
      border: 1px solid rgba(2, 132, 199, 0.15);
      color: var(--accent-sky);
    }

    .log-banner.banner-start .banner-icon {
      background: var(--accent-sky-dim);
      color: var(--accent-sky);
    }

    .log-banner.banner-success {
      background: linear-gradient(135deg, rgba(5, 150, 105, 0.08), rgba(5, 150, 105, 0.03));
      border: 1px solid rgba(5, 150, 105, 0.2);
      color: var(--accent-emerald);
    }

    .log-banner.banner-success .banner-icon {
      background: var(--accent-emerald-dim);
      color: var(--accent-emerald);
    }

    .log-banner.banner-error {
      background: linear-gradient(135deg, rgba(220, 38, 38, 0.08), rgba(220, 38, 38, 0.03));
      border: 1px solid rgba(220, 38, 38, 0.15);
      color: var(--accent-rose);
    }

    .log-banner.banner-error .banner-icon {
      background: var(--accent-rose-dim);
      color: var(--accent-rose);
    }

    .log-banner.banner-client {
      background: linear-gradient(135deg, rgba(124, 58, 237, 0.08), rgba(124, 58, 237, 0.03));
      border: 1px solid rgba(124, 58, 237, 0.15);
      color: var(--accent-violet);
    }

    .log-banner.banner-client .banner-icon {
      background: var(--accent-violet-dim);
      color: var(--accent-violet);
    }

    .log-banner.banner-report {
      background: linear-gradient(135deg, rgba(217, 119, 6, 0.08), rgba(217, 119, 6, 0.03));
      border: 1px solid rgba(217, 119, 6, 0.15);
      color: var(--accent-amber);
    }

    .log-banner.banner-report .banner-icon {
      background: var(--accent-amber-dim);
      color: var(--accent-amber);
    }

    /* Separator line between groups */
    .log-separator {
      height: 1px;
      background: var(--border-subtle);
      margin: 8px 0;
    }

    /* Workflow Progress Bar */
    .workflow-progress {
      padding: 10px 20px 12px;
      border-bottom: 1px solid var(--border-subtle);
      background: var(--bg-card);
      flex-shrink: 0;
    }

    .progress-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .progress-workflow {
      font-size: 0.72rem;
      font-weight: 600;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 70%;
    }

    .progress-step {
      font-size: 0.65rem;
      font-family: 'JetBrains Mono', monospace;
      color: var(--text-muted);
      flex-shrink: 0;
    }

    .progress-bar {
      height: 3px;
      background: var(--bg-elevated);
      border-radius: 2px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-sky), var(--accent-violet));
      border-radius: 2px;
      transition: width 0.4s ease;
      width: 0%;
    }

    /* Step Cards */
    .step-card {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px 12px;
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-left: 3px solid var(--accent-sky);
      border-radius: var(--radius-sm);
      animation: cardEnter 0.18s ease forwards;
      transition: border-color 0.15s ease, background 0.15s ease;
    }

    .step-card:hover {
      background: var(--bg-card-hover);
      border-left-color: var(--accent-sky);
    }

    .step-card.step-done {
      border-left-color: var(--accent-emerald);
      opacity: 0.85;
    }

    .step-card.step-error {
      border-left-color: var(--accent-rose);
      background: var(--accent-rose-dim);
    }

    .step-card.step-warning {
      border-left-color: var(--accent-amber);
    }

    .step-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
      margin-top: 4px;
      background: var(--accent-sky);
    }

    .step-card.step-done .step-dot {
      background: var(--accent-emerald);
      box-shadow: 0 0 6px rgba(5, 150, 105, 0.4);
    }

    .step-card.step-error .step-dot {
      background: var(--accent-rose);
      box-shadow: 0 0 6px rgba(220, 38, 38, 0.4);
    }

    .step-card.step-warning .step-dot {
      background: var(--accent-amber);
    }

    .step-body {
      flex: 1;
      min-width: 0;
    }

    .step-desc {
      font-size: 0.82rem;
      font-weight: 500;
      color: var(--text-primary);
      line-height: 1.4;
      word-break: break-word;
    }

    .step-card.step-error .step-desc {
      color: var(--accent-rose);
    }

    .step-action-chip {
      display: inline-flex;
      align-items: center;
      margin-top: 5px;
      padding: 1px 7px;
      background: var(--bg-elevated);
      border-radius: 3px;
      font-size: 0.6rem;
      font-family: 'JetBrains Mono', monospace;
      color: var(--text-muted);
      letter-spacing: 0.02em;
    }

    .step-time {
      font-size: 0.6rem;
      font-family: 'JetBrains Mono', monospace;
      color: var(--text-muted);
      flex-shrink: 0;
      padding-top: 3px;
      opacity: 0.6;
    }

    .step-card:hover .step-time {
      opacity: 1;
    }

    /* Download event card */
    .download-event-card {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      background: linear-gradient(135deg, rgba(5, 150, 105, 0.07), rgba(5, 150, 105, 0.03));
      border: 1px solid rgba(5, 150, 105, 0.2);
      border-left: 3px solid var(--accent-emerald);
      border-radius: var(--radius-sm);
      animation: cardEnter 0.2s ease forwards;
    }

    .download-event-icon {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      background: var(--accent-emerald-dim);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      color: var(--accent-emerald);
    }

    .download-event-icon svg {
      width: 14px;
      height: 14px;
    }

    .download-event-body {
      flex: 1;
      min-width: 0;
    }

    .download-event-label {
      font-size: 0.65rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--accent-emerald);
      margin-bottom: 1px;
    }

    .download-event-name {
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .download-event-time {
      font-size: 0.6rem;
      font-family: 'JetBrains Mono', monospace;
      color: var(--accent-emerald);
      opacity: 0.6;
      flex-shrink: 0;
    }

    /* Browser Preview */
    .browser-preview {
      flex: 1;
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-card);
    }

    .browser-chrome {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 16px;
      background: linear-gradient(to bottom, var(--bg-card), var(--bg-card-hover));
      border-bottom: 1px solid var(--border-subtle);
    }

    .browser-dots {
      display: flex;
      gap: 6px;
    }

    .browser-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .browser-dot.red { background: #ff5f57; }
    .browser-dot.yellow { background: #febc2e; }
    .browser-dot.green { background: #28c840; }

    .browser-url {
      flex: 1;
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 0.75rem;
      color: var(--text-muted);
      font-family: 'JetBrains Mono', monospace;
    }

    .live-indicator {
      display: none;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: var(--accent-rose);
      border-radius: 4px;
      font-size: 0.65rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: white;
    }

    .live-indicator.active {
      display: flex;
    }

    .live-dot {
      width: 6px;
      height: 6px;
      background: white;
      border-radius: 50%;
      animation: blink 1s ease-in-out infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    .browser-body {
      flex: 1;
      min-height: 200px;
      background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .browser-frame {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: none;
    }

    .browser-placeholder {
      text-align: center;
      color: var(--text-muted);
    }

    .placeholder-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    .browser-icon-wrapper {
      width: 80px;
      height: 80px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    .browser-icon-wrapper svg {
      width: 36px;
      height: 36px;
      color: var(--text-muted);
    }

    .browser-placeholder p {
      font-size: 0.95rem;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .placeholder-hint {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .browser-loading {
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
    }

    .browser-loading p {
      font-size: 0.9rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .fullscreen-btn {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: 6px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-muted);
      transition: all 0.2s ease;
    }

    .fullscreen-btn:hover {
      background: var(--accent-emerald);
      border-color: var(--accent-emerald);
      color: white;
    }

    .fullscreen-btn svg {
      width: 14px;
      height: 14px;
    }

    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 3px solid var(--bg-elevated);
      border-top-color: var(--accent-emerald);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Right Panel - Tabs */
    .tabs {
      display: flex;
      gap: 4px;
      padding: 4px;
      background: var(--bg-card);
      border-radius: var(--radius-md);
    }

    .tab {
      flex: 1;
      padding: 10px 12px;
      background: transparent;
      border: none;
      border-radius: var(--radius-sm);
      font-family: inherit;
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .tab:hover {
      color: var(--text-secondary);
    }

    .tab.active {
      background: var(--bg-deep);
      color: var(--text-primary);
    }

    .tab-content {
      display: none;
      flex: 1;
      overflow-y: auto;
    }

    .tab-content.active {
      display: block;
    }

    /* Timeline Tab */
    .timeline {
      position: relative;
      padding-left: 24px;
    }

    .timeline::before {
      content: '';
      position: absolute;
      left: 7px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--border-subtle);
    }

    .timeline-item {
      position: relative;
      padding-bottom: 20px;
    }

    .timeline-item:last-child {
      padding-bottom: 0;
    }

    .timeline-dot {
      position: absolute;
      left: -24px;
      top: 2px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--bg-card);
      border: 2px solid var(--border-medium);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .timeline-dot.completed {
      background: var(--accent-emerald);
      border-color: var(--accent-emerald);
    }

    .timeline-dot.running {
      background: var(--accent-amber);
      border-color: var(--accent-amber);
      animation: pulse 1.5s ease-in-out infinite;
    }

    .timeline-dot.pending {
      background: var(--bg-card);
      border-color: var(--border-medium);
    }

    .timeline-dot.error {
      background: var(--accent-rose);
      border-color: var(--accent-rose);
    }

    .timeline-dot svg {
      width: 10px;
      height: 10px;
      color: white;
    }

    .timeline-content {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      padding: 14px;
    }

    .timeline-title {
      font-size: 0.85rem;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .timeline-meta {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .timeline-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .timeline-empty svg {
      width: 40px;
      height: 40px;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    /* Memory Tab */
    .memory-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .memory-item {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      padding: 14px;
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }

    .memory-icon {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-sm);
      background: var(--accent-violet-dim);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      flex-shrink: 0;
    }

    .memory-content {
      flex: 1;
      min-width: 0;
    }

    .memory-key {
      font-size: 0.65rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .memory-value {
      font-size: 0.85rem;
      font-family: 'JetBrains Mono', monospace;
      color: var(--text-primary);
      word-break: break-word;
    }

    .memory-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    /* Downloads Tab */
    .downloads-breadcrumb {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 8px 10px;
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
      flex-wrap: wrap;
      min-height: 34px;
    }

    .breadcrumb-segment {
      font-size: 0.72rem;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 2px 6px;
      border-radius: 4px;
      transition: background 0.15s ease, color 0.15s ease;
      white-space: nowrap;
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .breadcrumb-segment:hover {
      background: var(--bg-elevated);
      color: var(--text-primary);
    }

    .breadcrumb-segment.active {
      color: var(--text-muted);
      cursor: default;
      font-weight: 400;
    }

    .breadcrumb-segment.active:hover {
      background: transparent;
      color: var(--text-muted);
    }

    .breadcrumb-chevron {
      color: var(--text-muted);
      flex-shrink: 0;
      opacity: 0.5;
    }

    .breadcrumb-chevron svg {
      width: 10px;
      height: 10px;
      display: block;
    }

    .downloads-summary-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 2px 8px;
    }

    .downloads-summary {
      font-size: 0.7rem;
      color: var(--text-muted);
      letter-spacing: 0.01em;
    }

    .clear-downloads-btn {
      font-family: inherit;
      font-size: 0.65rem;
      font-weight: 500;
      color: var(--accent-rose);
      background: var(--accent-rose-dim);
      border: none;
      border-radius: 4px;
      padding: 3px 8px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .clear-downloads-btn:hover {
      background: var(--accent-rose);
      color: white;
    }

    .download-all-btn {
      font-family: inherit;
      font-size: 0.65rem;
      font-weight: 500;
      color: var(--accent-emerald);
      background: var(--accent-emerald-dim);
      border: none;
      border-radius: 4px;
      padding: 3px 8px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .download-all-btn:hover {
      background: var(--accent-emerald);
      color: white;
    }

    .excel-preview-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.7rem;
      font-family: 'JetBrains Mono', monospace;
    }

    .excel-preview-table th {
      background: var(--bg-elevated);
      padding: 6px 8px;
      text-align: left;
      font-weight: 600;
      font-size: 0.65rem;
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border-medium);
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .excel-preview-table td {
      padding: 4px 8px;
      border-bottom: 1px solid var(--border-subtle);
      color: var(--text-secondary);
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .excel-preview-table tr:hover td {
      background: var(--bg-card-hover);
    }

    .excel-sheet-tabs {
      display: flex;
      gap: 2px;
      padding: 8px 0;
      overflow-x: auto;
    }

    .excel-sheet-tab {
      font-family: inherit;
      font-size: 0.65rem;
      padding: 4px 10px;
      border: 1px solid var(--border-subtle);
      border-radius: 4px;
      background: var(--bg-card);
      color: var(--text-secondary);
      cursor: pointer;
      white-space: nowrap;
    }

    .excel-sheet-tab.active {
      background: var(--accent-emerald-dim);
      border-color: var(--accent-emerald);
      color: var(--accent-emerald);
      font-weight: 600;
    }

    .downloads-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .download-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 9px 10px;
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: border-color 0.15s ease, background 0.15s ease;
    }

    .download-item:hover {
      border-color: var(--border-medium);
      background: var(--bg-card-hover);
    }

    .download-icon {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .download-icon.type-xlsx {
      background: rgba(5, 150, 105, 0.1);
      color: var(--accent-emerald);
    }

    .download-icon.type-pdf {
      background: var(--accent-rose-dim);
      color: var(--accent-rose);
    }

    .download-icon.type-docx {
      background: var(--accent-sky-dim);
      color: var(--accent-sky);
    }

    .download-icon.type-html {
      background: rgba(217, 119, 6, 0.1);
      color: var(--accent-amber);
    }

    .download-icon.type-zip {
      background: var(--accent-violet-dim);
      color: var(--accent-violet);
    }

    .download-icon.type-folder {
      background: rgba(217, 119, 6, 0.1);
      color: var(--accent-amber);
    }

    .download-icon.type-file {
      background: var(--accent-sky-dim);
      color: var(--accent-sky);
    }

    .download-icon svg {
      width: 16px;
      height: 16px;
    }

    .download-info {
      flex: 1;
      min-width: 0;
    }

    .download-name-row {
      display: flex;
      align-items: center;
      gap: 6px;
      min-width: 0;
    }

    .report-badge {
      font-size: 0.6rem;
      font-weight: 600;
      padding: 1px 5px;
      border-radius: 3px;
      letter-spacing: 0.04em;
      flex-shrink: 0;
      background: var(--accent-emerald-dim);
      color: var(--accent-emerald);
      font-family: 'JetBrains Mono', monospace;
    }

    .download-name {
      font-size: 0.8rem;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--text-primary);
    }

    .download-name-link {
      font-size: 0.8rem;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
      color: var(--text-primary);
      transition: color 0.15s ease;
    }

    .download-name-link:hover {
      color: var(--accent-emerald);
    }

    .download-meta {
      font-size: 0.68rem;
      color: var(--text-muted);
      margin-top: 1px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .download-meta-sep {
      opacity: 0.4;
    }

    .download-actions {
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: opacity 0.15s ease;
      flex-shrink: 0;
    }

    .download-item:hover .download-actions {
      opacity: 1;
    }

    .action-btn {
      width: 26px;
      height: 26px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-elevated);
      color: var(--text-secondary);
      transition: all 0.15s ease;
    }

    .action-btn:hover {
      background: var(--accent-emerald);
      color: white;
    }

    .action-btn.delete:hover {
      background: var(--accent-rose);
      color: white;
    }

    .action-btn svg {
      width: 13px;
      height: 13px;
    }

    .downloads-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    /* Setup Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(8px);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--bg-deep);
      border-radius: var(--radius-xl);
      padding: 32px;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      border: 1px solid var(--border-subtle);
    }

    .modal-header {
      text-align: center;
      margin-bottom: 28px;
    }

    .modal-icon {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, var(--accent-emerald), #059669);
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
      box-shadow: 0 8px 30px rgba(16, 185, 129, 0.3);
    }

    .modal-icon svg {
      width: 32px;
      height: 32px;
      color: white;
    }

    .modal-header h2 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .modal-header p {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .modal-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-group label {
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .form-input {
      padding: 14px 16px;
      border: 1px solid var(--border-medium);
      border-radius: var(--radius-md);
      font-family: inherit;
      font-size: 0.95rem;
      background: var(--bg-card);
      color: var(--text-primary);
      transition: all 0.2s ease;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent-emerald);
      box-shadow: 0 0 0 3px var(--accent-emerald-dim);
    }

    .form-input::placeholder {
      color: var(--text-muted);
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 8px;
    }

    .modal-actions .btn {
      flex: 1;
    }

    .btn-secondary {
      background: var(--bg-card);
      color: var(--text-primary);
      border: 1px solid var(--border-medium);
    }

    .btn-secondary:hover {
      background: var(--bg-card-hover);
    }

    .modal-footer {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--border-subtle);
      text-align: center;
    }

    .modal-footer p {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .modal-error {
      background: var(--accent-rose-dim);
      border: 1px solid var(--accent-rose);
      border-radius: var(--radius-sm);
      padding: 12px;
      color: var(--accent-rose);
      font-size: 0.85rem;
      display: none;
    }

    .modal-error.visible {
      display: block;
    }

    /* Fullscreen overlay */
    .fullscreen-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.95);
      z-index: 1000;
    }

    .fullscreen-overlay.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .fullscreen-overlay img {
      max-width: 95%;
      max-height: 95%;
      object-fit: contain;
    }

    .fullscreen-close {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 50%;
      background: var(--bg-card);
      color: var(--text-primary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .fullscreen-close svg {
      width: 20px;
      height: 20px;
    }

    /* Progress bar in header */
    .progress-ring {
      width: 36px;
      height: 36px;
    }

    .progress-ring circle {
      fill: none;
      stroke-width: 3;
    }

    .progress-ring .bg {
      stroke: var(--bg-card);
    }

    .progress-ring .progress {
      stroke: var(--accent-emerald);
      stroke-linecap: round;
      transform: rotate(-90deg);
      transform-origin: center;
      transition: stroke-dashoffset 0.5s ease;
    }

    /* Preview Modal */
    .preview-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.92);
      backdrop-filter: blur(12px);
      z-index: 3000;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .preview-overlay.active {
      display: flex;
    }

    .preview-modal {
      width: 90vw;
      height: 85vh;
      background: var(--bg-deep);
      border-radius: var(--radius-xl);
      border: 1px solid var(--border-subtle);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .preview-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-subtle);
      background: var(--bg-card);
      flex-shrink: 0;
    }

    .preview-header-icon {
      width: 36px;
      height: 36px;
      border-radius: var(--radius-sm);
      background: var(--accent-sky-dim);
      color: var(--accent-sky);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .preview-header-icon svg {
      width: 18px;
      height: 18px;
    }

    .preview-filename {
      flex: 1;
      font-size: 0.95rem;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      min-width: 0;
    }

    .preview-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }

    .preview-download-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--accent-emerald);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      font-family: inherit;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .preview-download-btn:hover {
      background: #047857;
      transform: translateY(-1px);
    }

    .preview-download-btn svg {
      width: 14px;
      height: 14px;
    }

    .preview-close-btn {
      width: 36px;
      height: 36px;
      border: 1px solid var(--border-medium);
      border-radius: var(--radius-sm);
      background: var(--bg-deep);
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .preview-close-btn:hover {
      background: var(--accent-rose);
      border-color: var(--accent-rose);
      color: white;
    }

    .preview-close-btn svg {
      width: 18px;
      height: 18px;
    }

    .preview-body {
      flex: 1;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-deepest);
    }

    .preview-body iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    .preview-body img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .preview-no-preview {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      padding: 40px;
      text-align: center;
    }

    .preview-no-preview-icon {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .preview-no-preview-icon svg {
      width: 36px;
      height: 36px;
      color: var(--text-muted);
    }

    .preview-no-preview p {
      font-size: 1rem;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .preview-no-preview span {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .preview-no-preview .preview-download-btn {
      margin-top: 8px;
      padding: 10px 20px;
      font-size: 0.85rem;
    }

  </style>
</head>
<body>
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>

  <!-- Setup Modal -->
  <div class="modal-overlay" id="setupModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
          </svg>
        </div>
        <h2>Xero Setup</h2>
        <p>Enter your Xero login credentials to get started</p>
      </div>
      <form class="modal-form" onsubmit="saveCredentials(event)">
        <div class="modal-error" id="setupError"></div>
        <div class="form-group">
          <label for="xeroEmail">Email Address</label>
          <input type="email" id="xeroEmail" class="form-input" placeholder="you@company.com" required>
        </div>
        <div class="form-group">
          <label for="xeroPassword">Password</label>
          <input type="password" id="xeroPassword" class="form-input" placeholder="Enter your Xero password" required>
        </div>
        <div class="modal-actions">
          <button type="submit" class="btn btn-primary" id="saveCredentialsBtn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
              <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
              <polyline points="17 21 17 13 7 13 7 21"></polyline>
              <polyline points="7 3 7 8 15 8"></polyline>
            </svg>
            Save & Continue
          </button>
        </div>
      </form>
      <div class="modal-footer">
        <p>Your credentials are stored locally in the .env file</p>
      </div>
    </div>
  </div>

  <div class="fullscreen-overlay" id="fullscreenOverlay" onclick="closeFullscreen()">
    <button class="fullscreen-close">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
    <img id="fullscreenImage" src="" alt="Browser View">
  </div>

  <!-- File Preview Modal -->
  <div class="preview-overlay" id="previewOverlay">
    <div class="preview-modal">
      <div class="preview-header">
        <div class="preview-header-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
          </svg>
        </div>
        <div class="preview-filename" id="previewFileName"></div>
        <div class="preview-actions">
          <button class="preview-download-btn" id="previewDownloadBtn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Download
          </button>
          <button class="preview-close-btn" onclick="closePreview()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
      </div>
      <div class="preview-body" id="previewBody"></div>
    </div>
  </div>

  <div class="app">
    <header class="header">
      <div class="brand">
        <div class="brand-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
          </svg>
        </div>
        <div class="brand-text">
          <h1>Xero Command Center</h1>
          <span>Workflow Automation</span>
        </div>
      </div>
      <div class="header-status">
        <svg class="progress-ring" id="progressRing" style="display: none;">
          <circle class="bg" cx="18" cy="18" r="15"></circle>
          <circle class="progress" cx="18" cy="18" r="15" stroke-dasharray="94.2" stroke-dashoffset="94.2"></circle>
        </svg>
        <div class="status-pill" id="statusPill">
          <div class="status-indicator" id="statusIndicator"></div>
          <span id="statusText">Ready</span>
        </div>
        <button class="action-btn" onclick="showSetupModal()" title="Settings">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
          </svg>
        </button>
      </div>
    </header>

    <main class="main">
      <!-- Left Panel - Clients -->
      <div class="panel" id="leftPanel">
        <div class="panel-header">
          <span class="panel-title">Clients</span>
          <button class="action-btn" onclick="selectAllClients()" title="Select All">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9 11 12 14 22 4"></polyline>
              <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
            </svg>
          </button>
        </div>
        <div class="panel-content">
          <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
            <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" onchange="handleFileUpload(event)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="17 8 12 3 7 8"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
            <h4>Upload Client List</h4>
            <p>Excel or CSV with client names</p>
          </div>

          <div class="file-loaded" id="fileLoaded" style="display: none;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
            </svg>
            <span id="fileName">clients.xlsx</span>
            <button onclick="removeFile()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>

          <div class="client-list" id="clientList">
            <div class="upload-prompt" style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
              <p style="font-size: 0.85rem;">Upload an Excel file to load clients</p>
            </div>
          </div>
        </div>
        <div class="action-bar">
          <button class="btn btn-primary" id="startBtn" onclick="startWorkflow()" disabled>
            <svg viewBox="0 0 24 24" fill="currentColor">
              <polygon points="5 3 19 12 5 21 5 3"></polygon>
            </svg>
            Start Processing
          </button>
          <button class="btn btn-danger" id="stopBtn" onclick="stopWorkflow()" disabled>
            <svg viewBox="0 0 24 24" fill="currentColor">
              <rect x="4" y="4" width="16" height="16" rx="2"></rect>
            </svg>
            Stop
          </button>
        </div>
      </div>

      <!-- Middle Panel - Browser & Activity -->
      <div class="panel middle-panel">
        <!-- Browser Preview Section (Top) -->
        <div class="browser-section">
          <div class="browser-preview" id="browserPreview">
            <div class="browser-chrome">
              <div class="browser-dots">
                <div class="browser-dot red"></div>
                <div class="browser-dot yellow"></div>
                <div class="browser-dot green"></div>
              </div>
              <div class="browser-url" id="browserUrl">Ready to connect...</div>
              <div class="live-indicator" id="liveIndicator">
                <div class="live-dot"></div>
                LIVE
              </div>
              <button class="fullscreen-btn" onclick="openFullscreen()" title="Fullscreen">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="15 3 21 3 21 9"></polyline>
                  <polyline points="9 21 3 21 3 15"></polyline>
                  <line x1="21" y1="3" x2="14" y2="10"></line>
                  <line x1="3" y1="21" x2="10" y2="14"></line>
                </svg>
              </button>
            </div>
            <div class="browser-body">
              <img class="browser-frame" id="browserFrame" alt="Browser View">
              <div class="browser-placeholder" id="browserPlaceholder">
                <div class="placeholder-content">
                  <div class="browser-icon-wrapper">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                      <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                      <line x1="8" y1="21" x2="16" y2="21"></line>
                      <line x1="12" y1="17" x2="12" y2="21"></line>
                    </svg>
                  </div>
                  <p>Browser preview will appear here</p>
                  <span class="placeholder-hint">Start processing to see live view</span>
                </div>
              </div>
              <div class="browser-loading" id="browserLoading" style="display: none;">
                <div class="loading-spinner"></div>
                <p>Launching browser...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Activity Log Section (Bottom) -->
        <div class="activity-section">
          <div class="section-header">
            <span class="section-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="15" height="15">
                <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
              </svg>
              Activity Log
              <span class="log-count-badge" id="logCountBadge">0</span>
            </span>
            <div class="section-controls">
              <button class="action-btn" onclick="clearActivity()" title="Clear log">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
              </button>
            </div>
          </div>
          <div class="workflow-progress" id="workflowProgress" style="display:none;">
            <div class="progress-info">
              <span class="progress-workflow" id="progressWorkflow"></span>
              <span class="progress-step" id="progressStep"></span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill"></div>
            </div>
          </div>
          <div class="activity-content" id="activityPanel">
            <div class="activity-empty" id="activityEmpty">
              <div class="empty-state-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                </svg>
              </div>
              <div class="empty-state-text">
                <p>No activity yet</p>
                <span>Events will appear here as the workflow runs</span>
              </div>
            </div>
            <div class="activity-feed" id="activityFeed" style="display: none;"></div>
          </div>
        </div>
      </div>

      <!-- Resize Handle -->
      <div class="resize-handle" id="resizeHandle"></div>

      <!-- Right Panel - Tabs -->
      <div class="panel" id="rightPanel">
        <div class="panel-header">
          <div class="tabs">
            <button class="tab active" onclick="switchTab('timeline')">Timeline</button>
            <button class="tab" onclick="switchTab('memory')">Memory</button>
            <button class="tab" onclick="switchTab('downloads')">Downloads</button>
          </div>
        </div>
        <div class="panel-content">
          <!-- Timeline Tab -->
          <div class="tab-content active" id="timelineTab">
            <div class="timeline-empty" id="timelineEmpty">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              <p>Workflow stages will appear here</p>
            </div>
            <div class="timeline" id="timeline" style="display: none;"></div>
          </div>

          <!-- Memory Tab -->
          <div class="tab-content" id="memoryTab">
            <div class="memory-empty" id="memoryEmpty">
              <p>No captured variables yet</p>
            </div>
            <div class="memory-list" id="memoryList" style="display: none;"></div>
          </div>

          <!-- Downloads Tab -->
          <div class="tab-content" id="downloadsTab">
            <nav class="downloads-breadcrumb" id="downloadsBreadcrumb">
              <span class="breadcrumb-segment active">Downloads</span>
            </nav>
            <div class="downloads-summary-row" id="downloadsSummaryRow" style="display:none;">
              <div class="downloads-summary" id="downloadsSummary"></div>
              <div style="display:flex;gap:4px;">
                <button class="download-all-btn" onclick="downloadAllAsZip()" title="Download all as ZIP">Download All</button>
                <button class="clear-downloads-btn" onclick="clearAllDownloads()" title="Clear all downloads">Clear All</button>
              </div>
            </div>
            <div class="downloads-list" id="downloadsList">
              <div class="downloads-empty">Loading...</div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    let ws = null;
    let isRunning = false;
    let clients = [];
    let currentDownloadPath = '';
    let timelineStages = [];

    const availableReports = [
      { id: 'trial_balance_report', name: 'Trial Balance' },
      { id: 'profit_and_loss', name: 'Profit & Loss' },
      { id: 'aged_receivables_detail', name: 'Aged Receivables' },
      { id: 'aged_payables_detail', name: 'Aged Payables' },
      { id: 'account_transactions', name: 'Account Transactions' },
      { id: 'receivable_invoice_detail', name: 'Receivable Invoices' },
      { id: 'payable_invoice_detail', name: 'Payable Invoices' },
      { id: 'vat_returns', name: 'VAT Returns' }
    ];

    let wsRetryCount = 0;
    const WS_MAX_RETRIES = 5;
    const WS_BASE_DELAY = 2000;

    function connect() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${window.location.host}/ws`);

      ws.onopen = () => {
        console.log('Connected');
        wsRetryCount = 0;
        loadDownloads();
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        handleMessage(data);
      };

      ws.onerror = () => {
        console.warn('WebSocket connection error');
      };

      ws.onclose = () => {
        if (wsRetryCount >= WS_MAX_RETRIES) {
          console.error('WebSocket: max retries reached. Server may not support WebSocket connections.');
          addActivityCard({
            type: 'log',
            level: 'error',
            timestamp: new Date().toLocaleTimeString(),
            message: 'Unable to connect to server. This app requires a server that supports WebSocket connections (not serverless platforms like Vercel).'
          });
          return;
        }
        wsRetryCount++;
        const delay = WS_BASE_DELAY * Math.pow(2, wsRetryCount - 1);
        console.log(`Disconnected, reconnecting in ${delay / 1000}s (attempt ${wsRetryCount}/${WS_MAX_RETRIES})...`);
        setTimeout(connect, delay);
      };
    }

    function handleMessage(data) {
      if (data.type === 'log') {
        addActivityCard(data);

        if (data.message && data.message.includes('report generated')) {
          loadDownloads(currentDownloadPath);
        }

        if (data.level === 'success' && data.message.startsWith('Completed:')) {
          const workflowName = data.message.replace('Completed:', '').trim();
          const stage = timelineStages.find(s => s.id === workflowName);
          if (stage) {
            stage.status = 'completed';
            updateTimeline(timelineStages);
          }
        } else if (data.level === 'error' && timelineStages.length > 0) {
          const runningStage = timelineStages.find(s => s.status === 'running');
          if (runningStage) {
            runningStage.status = 'error';
            updateTimeline(timelineStages);
          }
        }
      } else if (data.type === 'status') {
        updateStatus(data);
      } else if (data.type === 'frame') {
        updateBrowserFrame(data.data);
      } else if (data.type === 'variables') {
        updateMemory(data.variables);
      }
    }

    // File Upload
    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

          // Extract client names from first column (skip header if present)
          clients = jsonData
            .slice(1)
            .map(row => row[0])
            .filter(name => name && typeof name === 'string' && name.trim());

          if (clients.length === 0) {
            clients = jsonData
              .map(row => row[0])
              .filter(name => name && typeof name === 'string' && name.trim());
          }

          renderClients();
          document.getElementById('uploadZone').style.display = 'none';
          document.getElementById('fileLoaded').style.display = 'flex';
          document.getElementById('fileName').textContent = file.name;
          document.getElementById('startBtn').disabled = false;
        } catch (error) {
          console.error('Failed to parse file:', error);
          alert('Failed to parse file. Please upload a valid Excel or CSV file.');
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function removeFile() {
      clients = [];
      document.getElementById('uploadZone').style.display = 'block';
      document.getElementById('fileLoaded').style.display = 'none';
      document.getElementById('fileInput').value = '';
      document.getElementById('clientList').innerHTML = `
        <div class="upload-prompt" style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
          <p style="font-size: 0.85rem;">Upload an Excel file to load clients</p>
        </div>
      `;
      document.getElementById('startBtn').disabled = true;
    }

    function renderClients() {
      const list = document.getElementById('clientList');
      list.innerHTML = clients.map((client, index) => {
        const initials = client.split(' ').map(w => w[0]).slice(0, 2).join('').toUpperCase();
        const colors = ['var(--accent-violet)', 'var(--accent-sky)', 'var(--accent-emerald)', 'var(--accent-amber)', 'var(--accent-rose)'];
        const color = colors[index % colors.length];

        return `
          <div class="client-item" id="client-${index}">
            <div class="client-header" onclick="toggleClient(${index})">
              <input type="checkbox" class="client-checkbox" data-client="${client}" checked onclick="event.stopPropagation(); toggleClientReports(${index}, this.checked)">
              <div class="client-avatar" style="background: linear-gradient(135deg, ${color}, ${color}88);">${initials}</div>
              <div class="client-info">
                <div class="client-name">${client}</div>
                <div class="client-meta">${availableReports.length} reports available</div>
              </div>
              <div class="client-expand" id="expand-${index}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
              </div>
            </div>
            <div class="client-reports" id="reports-${index}">
              <button class="report-toggle-all" onclick="event.stopPropagation(); toggleAllReports(${index})" id="toggle-${index}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>
                Deselect All
              </button>
              ${availableReports.map(report => `
                <label class="report-item">
                  <input type="checkbox" data-client="${client}" data-report="${report.id}" checked onchange="syncClientCheckbox(${index}); updateToggleLabel(${index})">
                  <span>${report.name}</span>
                </label>
              `).join('')}
            </div>
          </div>
        `;
      }).join('');
    }

    function toggleClient(index) {
      const expand = document.getElementById(`expand-${index}`);
      const reports = document.getElementById(`reports-${index}`);
      expand.classList.toggle('expanded');
      reports.classList.toggle('visible');
    }

    function toggleClientReports(clientIndex, checked) {
      const container = document.getElementById(`reports-${clientIndex}`);
      container.querySelectorAll('.report-item input').forEach(cb => cb.checked = checked);
      updateToggleLabel(clientIndex);
    }

    function toggleAllReports(clientIndex) {
      const container = document.getElementById(`reports-${clientIndex}`);
      const checkboxes = container.querySelectorAll('.report-item input');
      const allChecked = Array.from(checkboxes).every(cb => cb.checked);
      checkboxes.forEach(cb => cb.checked = !allChecked);
      syncClientCheckbox(clientIndex);
      updateToggleLabel(clientIndex);
    }

    function syncClientCheckbox(clientIndex) {
      const container = document.getElementById(`reports-${clientIndex}`);
      const checkboxes = container.querySelectorAll('.report-item input');
      const clientCb = document.querySelector(`#client-${clientIndex} .client-checkbox`);
      if (clientCb) clientCb.checked = Array.from(checkboxes).some(cb => cb.checked);
    }

    function updateToggleLabel(clientIndex) {
      const container = document.getElementById(`reports-${clientIndex}`);
      const checkboxes = container.querySelectorAll('.report-item input');
      const toggle = document.getElementById(`toggle-${clientIndex}`);
      const allChecked = Array.from(checkboxes).every(cb => cb.checked);

      toggle.innerHTML = allChecked
        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg> Deselect All'
        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg> Select All';
    }

    function selectAllClients() {
      const checkboxes = document.querySelectorAll('.client-checkbox, .report-item input');
      const allChecked = Array.from(checkboxes).every(cb => cb.checked);
      checkboxes.forEach(cb => cb.checked = !allChecked);
    }

    // Workflow Control
    function getSelectedClients() {
      return Array.from(document.querySelectorAll('.client-checkbox:checked'))
        .map(cb => cb.dataset.client);
    }

    function getSelectedReports() {
      return Array.from(document.querySelectorAll('.report-item input:checked'))
        .map(cb => cb.dataset.report)
        .filter((value, index, self) => self.indexOf(value) === index);
    }

    function startWorkflow() {
      const selectedClients = getSelectedClients();
      if (selectedClients.length === 0) {
        alert('Please select at least one client');
        return;
      }

      const selectedReports = getSelectedReports();

      showBrowserLoading();

      // Build workflow list
      const workflows = ['login_and_redirect', 'navigate_to_reports', ...selectedReports];

      // Create timeline stages from actual workflows
      const workflowDisplayNames = {
        'login_and_redirect': 'Login & Select Client',
        'navigate_to_reports': 'Navigate to Reports',
        'trial_balance_report': 'Trial Balance',
        'profit_and_loss': 'Profit & Loss',
        'aged_receivables_detail': 'Aged Receivables',
        'aged_payables_detail': 'Aged Payables',
        'account_transactions': 'Account Transactions',
        'receivable_invoice_detail': 'Receivable Invoices',
        'payable_invoice_detail': 'Payable Invoices',
        'vat_returns': 'VAT Returns',
        'get_financial_year_end': 'Financial Year End'
      };

      timelineStages = workflows.map(w => ({
        id: w,
        name: workflowDisplayNames[w] || w.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase()),
        status: 'pending'
      }));

      updateTimeline(timelineStages);

      if (!ws || ws.readyState !== WebSocket.OPEN) {
        addActivityCard({
          type: 'log',
          level: 'error',
          timestamp: new Date().toLocaleTimeString(),
          message: 'Not connected to server. Please ensure the backend is running and refresh the page.'
        });
        return;
      }

      ws.send(JSON.stringify({
        action: 'start',
        clients: selectedClients,
        reports: selectedReports,
        workflows: workflows
      }));
    }

    function stopWorkflow() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ action: 'stop' }));
      }
    }

    // Status Updates
    function updateStatus(data) {
      const pill = document.getElementById('statusPill');
      const indicator = document.getElementById('statusIndicator');
      const text = document.getElementById('statusText');
      const startBtn = document.getElementById('startBtn');
      const stopBtn = document.getElementById('stopBtn');
      const progressRing = document.getElementById('progressRing');

      if (data.status === 'running') {
        isRunning = true;
        pill.classList.add('running');
        indicator.classList.add('active');
        text.textContent = data.current_workflow ? `Running: ${data.current_workflow.replace(/_/g, ' ')}` : 'Running';
        startBtn.disabled = true;
        stopBtn.disabled = false;
        progressRing.style.display = 'block';

        if (data.progress !== undefined && data.total) {
          const percent = ((data.progress + 1) / data.total);
          const circumference = 94.2;
          const offset = circumference * (1 - percent);
          progressRing.querySelector('.progress').style.strokeDashoffset = offset;
        }

        // Update timeline based on current workflow
        if (data.current_workflow && timelineStages.length > 0) {
          const currentIdx = timelineStages.findIndex(s => s.id === data.current_workflow);
          if (currentIdx !== -1) {
            timelineStages.forEach((stage, idx) => {
              if (idx < currentIdx) {
                stage.status = 'completed';
              } else if (idx === currentIdx) {
                stage.status = 'running';
              } else {
                stage.status = 'pending';
              }
            });
            updateTimeline(timelineStages);
          }
        }
      } else {
        isRunning = false;
        pill.classList.remove('running');
        indicator.classList.remove('active');
        text.textContent = 'Ready';
        startBtn.disabled = clients.length === 0;
        stopBtn.disabled = true;
        progressRing.style.display = 'none';
        hideBrowserFrame();
        if (timelineStages.length > 0) {
          timelineStages.forEach(stage => stage.status = 'completed');
          updateTimeline(timelineStages);
        }
        loadDownloads(currentDownloadPath);
      }
    }

    let logCount = 0;
    let workflowStepCount = 0;
    let currentWorkflowName = '';

    function stripEmoji(text) {
      return text.replace(/[\u{1F300}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{FE00}-\u{FE0F}\u{1F000}-\u{1F02F}\u{1F0A0}-\u{1F0FF}\u{1F100}-\u{1F64F}\u{1F680}-\u{1F6FF}\u{1FA00}-\u{1FA6F}\u{1FA70}-\u{1FAFF}\u{200D}\u{20E3}\u{FE0F}]/gu, '').replace(/^\s+/, '').replace(/\s{2,}/g, ' ');
    }

    function classifyMessage(msg, level) {
      const m = msg.toLowerCase();
      if (!msg.trim()) return 'skip';
      if (m.includes('\u2554') || m.includes('\u2551') || m.includes('\u255a') || m.includes('\u2557') || m.includes('\u255d')) return 'skip';
      if (m.includes('navigating from:')) return 'skip';
      if (m.includes('now at:') || m.includes('after reload:')) return 'skip';
      if (m.includes('page loaded successfully') || m.includes('page ready')) return 'skip';
      if (m.includes('input filled successfully')) return 'skip';
      if (m.includes('click successful')) return 'skip';
      if (m.includes('key pressed successfully')) return 'skip';
      if (m.includes('state captured')) return 'skip';
      if (m.includes('connected to xero')) return 'skip';
      if (m.includes('starting workflow chain')) return 'chain-start';
      if (m.match(/running workflow \d+\/\d+/)) return 'workflow-start';
      if (m.includes('workflow chain finished')) return 'chain-end';
      if (m.includes('all workflows completed')) return 'all-complete';
      if (m.includes('all reports completed for')) return 'client-complete';
      if (m.includes('processing client')) return 'client-start';
      if (m.includes('report generated') || m.includes('summary generated')) return 'report';
      if (m.includes('file downloaded') || m.includes('saved to')) return 'download-complete';
      if (m.includes('workflow failed') || m.includes('login/client selection failed')) return 'fatal-error';
      const stripped = stripEmoji(msg);
      if (stripped.trimStart().startsWith('\u25b6')) return 'step';
      return 'log';
    }

    const svgIcons = {
      play: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>',
      check: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>',
      x: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>',
      user: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>',
      file: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>',
      zap: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>',
    };

    function createBanner(type, icon, title, sub, time) {
      const el = document.createElement('div');
      el.className = `log-banner banner-${type}`;
      el.innerHTML = `
        <div class="banner-icon">${icon}</div>
        <div class="banner-body">
          <div class="banner-title">${title}</div>
          ${sub ? `<div class="banner-sub">${sub}</div>` : ''}
        </div>
        <span class="banner-time">${time}</span>
      `;
      return el;
    }

    function createLogEntry(level, message, time, extraData) {
      const el = document.createElement('div');
      el.className = `log-entry level-${level}`;

      let chipsHtml = '';
      if (extraData && Object.keys(extraData).length > 0) {
        const chips = Object.entries(extraData).map(([k, v]) => {
          const val = typeof v === 'object' ? JSON.stringify(v) : v;
          return `<span class="log-chip"><span class="log-chip-key">${k}:</span> ${val}</span>`;
        }).join('');
        chipsHtml = `<div class="log-chips">${chips}</div>`;
      }

      el.innerHTML = `
        <div class="log-dot"></div>
        <div style="flex:1;min-width:0">
          <div class="log-text">${message}</div>
          ${chipsHtml}
        </div>
        <span class="log-time">${time}</span>
      `;
      return el;
    }

    function inferActionChip(text) {
      const t = text.toLowerCase();
      if (t.includes('click') || t.includes('select') || t.includes('press')) return 'click';
      if (t.includes('fill') || t.includes('type') || t.includes('enter') || t.includes('input')) return 'fill';
      if (t.includes('wait') || t.includes('delay')) return 'wait';
      if (t.includes('navigat') || t.includes('redirect') || t.includes('open')) return 'navigate';
      if (t.includes('download') || t.includes('export') || t.includes('generat')) return 'download';
      if (t.includes('login') || t.includes('sign in') || t.includes('authenticat')) return 'auth';
      if (t.includes('search') || t.includes('find') || t.includes('look')) return 'search';
      return 'step';
    }

    function createStepCard(desc, level, time) {
      const el = document.createElement('div');
      const stateClass = level === 'error' ? 'step-error' : level === 'warning' ? 'step-warning' : level === 'success' ? 'step-done' : '';
      el.className = `step-card${stateClass ? ' ' + stateClass : ''}`;
      const chip = inferActionChip(desc);
      el.innerHTML = `
        <div class="step-dot"></div>
        <div class="step-body">
          <div class="step-desc">${desc}</div>
          <span class="step-action-chip">${chip}</span>
        </div>
        <span class="step-time">${time}</span>
      `;
      return el;
    }

    function createDownloadEventCard(msg, time) {
      const el = document.createElement('div');
      el.className = 'download-event-card';
      const rawPath = msg.replace(/.*saved to\s*/i, '').replace(/.*file downloaded[:\s]*/i, '');
      const filename = rawPath.split('/').pop() || rawPath;
      const parsed = parseReportName(filename);
      const displayName = parsed
        ? parsed.name
        : filename.replace(/\.[^.]+$/, '') || filename;
      el.innerHTML = `
        <div class="download-event-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <polyline points="7 15 12 20 17 15"></polyline>
            <line x1="12" y1="20" x2="12" y2="10"></line>
          </svg>
        </div>
        <div class="download-event-body">
          <div class="download-event-label">File Saved</div>
          <div class="download-event-name" title="${filename}">${displayName}</div>
        </div>
        <span class="download-event-time">${time}</span>
      `;
      return el;
    }

    function updateWorkflowProgress(workflowName, stepNum, totalSteps) {
      const bar = document.getElementById('workflowProgress');
      const nameEl = document.getElementById('progressWorkflow');
      const stepEl = document.getElementById('progressStep');
      const fill = document.getElementById('progressFill');
      bar.style.display = 'block';
      nameEl.textContent = workflowName;
      if (totalSteps > 0) {
        stepEl.textContent = `${stepNum} / ${totalSteps}`;
        fill.style.width = `${Math.min(100, (stepNum / totalSteps) * 100)}%`;
      } else {
        stepEl.textContent = `step ${stepNum}`;
        fill.style.width = `${Math.min(100, stepNum * 8)}%`;
      }
    }

    function hideWorkflowProgress() {
      const bar = document.getElementById('workflowProgress');
      const fill = document.getElementById('progressFill');
      fill.style.width = '100%';
      setTimeout(() => { bar.style.display = 'none'; fill.style.width = '0%'; }, 600);
    }

    function addActivityCard(data) {
      const empty = document.getElementById('activityEmpty');
      const feed = document.getElementById('activityFeed');
      const panel = document.getElementById('activityPanel');

      if (empty.style.display !== 'none') {
        empty.style.display = 'none';
        feed.style.display = 'flex';
      }

      const level = data.level || 'info';
      const rawMsg = data.message || '';
      const msg = stripEmoji(rawMsg);
      const time = data.timestamp || '';
      const type = classifyMessage(rawMsg, level);

      if (type === 'skip' || !msg.trim()) return;

      let el;

      switch (type) {
        case 'chain-start': {
          workflowStepCount = 0;
          currentWorkflowName = '';
          const workflows = msg.replace(/Starting workflow chain:\s*/i, '');
          el = createBanner('start', svgIcons.zap, 'Workflow Chain Started', workflows, time);
          break;
        }
        case 'workflow-start': {
          workflowStepCount = 0;
          currentWorkflowName = msg.replace(/Running workflow \d+\/\d+:\s*/i, '').replace(/_/g, ' ');
          updateWorkflowProgress(currentWorkflowName, 0, 0);
          el = createBanner('start', svgIcons.play, `Running: ${currentWorkflowName}`, null, time);
          break;
        }
        case 'chain-end':
          hideWorkflowProgress();
          el = createBanner('success', svgIcons.check, 'Workflow Chain Finished', null, time);
          break;
        case 'all-complete':
          hideWorkflowProgress();
          el = createBanner('success', svgIcons.check, 'All Workflows Completed', null, time);
          break;
        case 'client-complete': {
          const client = msg.replace(/All reports completed for:\s*/i, '');
          el = createBanner('success', svgIcons.check, `Completed: ${client}`, null, time);
          break;
        }
        case 'client-start': {
          workflowStepCount = 0;
          const info = msg.replace(/Processing client\s*/i, '');
          el = createBanner('client', svgIcons.user, 'Processing Client', info, time);
          break;
        }
        case 'report': {
          const path = msg.replace(/.*:\s*/, '');
          el = createBanner('report', svgIcons.file, 'Report Generated', path, time);
          break;
        }
        case 'download-complete':
          el = createDownloadEventCard(msg, time);
          break;
        case 'fatal-error':
          hideWorkflowProgress();
          el = createBanner('error', svgIcons.x, msg, null, time);
          break;
        case 'step': {
          const desc = msg.replace(/^\s*\u25b6\s*/, '').trim();
          workflowStepCount++;
          if (currentWorkflowName) {
            updateWorkflowProgress(currentWorkflowName, workflowStepCount, 0);
          }
          el = createStepCard(desc, level, time);
          break;
        }
        default:
          el = createLogEntry(level, msg, time, data.data);
          break;
      }

      feed.insertBefore(el, feed.firstChild);
      panel.scrollTop = 0;

      logCount++;
      document.getElementById('logCountBadge').textContent = logCount;

      while (feed.children.length > 150) {
        feed.removeChild(feed.lastChild);
      }
    }

    function clearActivity() {
      logCount = 0;
      workflowStepCount = 0;
      currentWorkflowName = '';
      document.getElementById('activityFeed').innerHTML = '';
      document.getElementById('activityFeed').style.display = 'none';
      document.getElementById('activityEmpty').style.display = 'flex';
      document.getElementById('logCountBadge').textContent = '0';
      document.getElementById('workflowProgress').style.display = 'none';
      document.getElementById('progressFill').style.width = '0%';
    }

    // Browser Frame
    function updateBrowserFrame(frameData) {
      const frame = document.getElementById('browserFrame');
      const placeholder = document.getElementById('browserPlaceholder');
      const loading = document.getElementById('browserLoading');
      const liveIndicator = document.getElementById('liveIndicator');
      const urlBar = document.getElementById('browserUrl');

      if (frameData) {
        frame.src = 'data:image/jpeg;base64,' + frameData;
        frame.style.display = 'block';
        placeholder.style.display = 'none';
        loading.style.display = 'none';
        liveIndicator.classList.add('active');
        urlBar.textContent = 'Connected to Xero';
      }
    }

    function showBrowserLoading() {
      document.getElementById('browserPlaceholder').style.display = 'none';
      document.getElementById('browserLoading').style.display = 'flex';
      document.getElementById('browserUrl').textContent = 'Launching browser...';
    }

    function hideBrowserFrame() {
      document.getElementById('browserFrame').style.display = 'none';
      document.getElementById('browserPlaceholder').style.display = 'flex';
      document.getElementById('browserLoading').style.display = 'none';
      document.getElementById('liveIndicator').classList.remove('active');
      document.getElementById('browserUrl').textContent = 'Ready to connect...';
    }

    function openFullscreen() {
      const frame = document.getElementById('browserFrame');
      if (frame.src) {
        document.getElementById('fullscreenImage').src = frame.src;
        document.getElementById('fullscreenOverlay').classList.add('active');
      }
    }

    function closeFullscreen() {
      document.getElementById('fullscreenOverlay').classList.remove('active');
    }

    // Tabs
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

      event.target.classList.add('active');
      document.getElementById(`${tabName}Tab`).classList.add('active');

      if (tabName === 'downloads') {
        loadDownloads();
      }
    }

    // Timeline
    function updateTimeline(stages) {
      const empty = document.getElementById('timelineEmpty');
      const timeline = document.getElementById('timeline');

      empty.style.display = 'none';
      timeline.style.display = 'block';

      timeline.innerHTML = stages.map((stage, i) => {
        const dotClass = stage.status === 'error' ? 'error' :
                        stage.status === 'completed' ? 'completed' :
                        stage.status === 'running' ? 'running' : 'pending';

        let icon = '';
        if (stage.status === 'completed') {
          icon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>';
        } else if (stage.status === 'error') {
          icon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
        }

        const statusText = stage.status === 'running' ? 'In progress...' :
                          stage.status === 'error' ? 'Failed' :
                          stage.status === 'completed' ? 'Completed' : 'Pending';

        return `
          <div class="timeline-item">
            <div class="timeline-dot ${dotClass}">${icon}</div>
            <div class="timeline-content">
              <div class="timeline-title">${stage.name}</div>
              <div class="timeline-meta">${statusText}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Memory
    function updateMemory(variables) {
      const empty = document.getElementById('memoryEmpty');
      const list = document.getElementById('memoryList');

      if (!variables || Object.keys(variables).length === 0) {
        empty.style.display = 'block';
        list.style.display = 'none';
        return;
      }

      empty.style.display = 'none';
      list.style.display = 'flex';

      const getIcon = (key) => {
        if (key.includes('date')) return '';
        if (key.includes('company') || key.includes('client')) return '';
        if (key.includes('file') || key.includes('download')) return '';
        if (key.includes('url')) return '';
        if (key.includes('vat')) return '';
        return '';
      };

      list.innerHTML = Object.entries(variables).map(([key, value]) => `
        <div class="memory-item">
          <div class="memory-icon">${getIcon(key)}</div>
          <div class="memory-content">
            <div class="memory-key">${key.replace(/_/g, ' ')}</div>
            <div class="memory-value">${value}</div>
          </div>
        </div>
      `).join('');
    }

    const REPORT_CODES = {
      'TB': 'Trial Balance',
      'P&L': 'Profit & Loss',
      'AR': 'Aged Receivables',
      'AP': 'Aged Payables',
      'AT': 'Account Transactions',
      'RID': 'Receivable Invoice Detail',
      'PID': 'Payable Invoice Detail',
      'VAT': 'VAT Returns'
    };

    function parseReportName(filename) {
      const oldMatch = filename.match(/^(\d+)\s+([A-Z&]+)_(.+?)_(\d{2}-\w{3}-\d{4})_[\d-]+(\.\w+)$/);
      if (oldMatch) return { number: oldMatch[1], code: oldMatch[2], name: oldMatch[3].replace(/_/g, ' '), ext: oldMatch[5] };
      const newMatch = filename.match(/^(\d+)\s+(.+?)(\.\w+)$/);
      if (newMatch) return { number: newMatch[1], code: null, name: newMatch[2].replace(/_/g, ' '), ext: newMatch[3] };
      return null;
    }

    function getFileIconSvg(typeClass) {
      if (typeClass === 'type-folder') {
        return `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
        </svg>`;
      }
      if (typeClass === 'type-xlsx') {
        return `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="8" y1="13" x2="16" y2="13"></line>
          <line x1="8" y1="17" x2="16" y2="17"></line>
        </svg>`;
      }
      if (typeClass === 'type-pdf') {
        return `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="9" y1="15" x2="15" y2="15"></line>
        </svg>`;
      }
      if (typeClass === 'type-zip') {
        return `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 10H3M21 10V20a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V10M21 10V8l-3-5H6L3 8v2M12 12v8M12 12h2M12 20h2"></path>
        </svg>`;
      }
      if (typeClass === 'type-html') {
        return `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="16 18 22 12 16 6"></polyline>
          <polyline points="8 6 2 12 8 18"></polyline>
        </svg>`;
      }
      if (typeClass === 'type-docx') {
        return `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="8" y1="13" x2="16" y2="13"></line>
          <line x1="8" y1="17" x2="12" y2="17"></line>
        </svg>`;
      }
      return `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
        <polyline points="14 2 14 8 20 8"></polyline>
      </svg>`;
    }

    function getTypeClass(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      const map = { xlsx: 'type-xlsx', xls: 'type-xlsx', pdf: 'type-pdf', docx: 'type-docx', doc: 'type-docx', html: 'type-html', htm: 'type-html', zip: 'type-zip' };
      return map[ext] || 'type-file';
    }

    function relativeTime(ts) {
      const diff = Math.floor((Date.now() / 1000) - ts);
      if (diff < 60) return 'just now';
      if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
      if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
      if (diff < 604800) return `${Math.floor(diff / 86400)}d ago`;
      return `${Math.floor(diff / 604800)}w ago`;
    }

    function buildBreadcrumb(subpath) {
      const breadcrumb = document.getElementById('downloadsBreadcrumb');
      const chevron = `<span class="breadcrumb-chevron"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"></polyline></svg></span>`;

      let html = `<span class="breadcrumb-segment" onclick="loadDownloads('')">Downloads</span>`;

      if (subpath) {
        const parts = subpath.split('/').filter(Boolean);
        parts.forEach((part, i) => {
          const partPath = parts.slice(0, i + 1).join('/');
          const isLast = i === parts.length - 1;
          html += chevron;
          if (isLast) {
            html += `<span class="breadcrumb-segment active" title="${part}">${part}</span>`;
          } else {
            html += `<span class="breadcrumb-segment" onclick="loadDownloads('${partPath}')" title="${part}">${part}</span>`;
          }
        });
      } else {
        html = `<span class="breadcrumb-segment active">Downloads</span>`;
      }

      breadcrumb.innerHTML = html;
    }

    async function loadDownloads(subpath = '') {
      try {
        const url = subpath ? `/api/downloads?subpath=${encodeURIComponent(subpath)}` : '/api/downloads';
        const response = await fetch(url);
        const data = await response.json();
        const list = document.getElementById('downloadsList');
        const summaryEl = document.getElementById('downloadsSummary');
        const summaryRow = document.getElementById('downloadsSummaryRow');

        currentDownloadPath = data.subpath || '';
        buildBreadcrumb(currentDownloadPath);

        if (data.items.length === 0) {
          summaryRow.style.display = 'none';
          list.innerHTML = '<div class="downloads-empty">No files yet</div>';
          return;
        }

        const folderCount = data.items.filter(i => i.type === 'folder').length;
        const fileCount = data.items.filter(i => i.type === 'file').length;
        const parts = [];
        if (folderCount) parts.push(`${folderCount} folder${folderCount !== 1 ? 's' : ''}`);
        if (fileCount) parts.push(`${fileCount} file${fileCount !== 1 ? 's' : ''}`);
        summaryEl.textContent = parts.join(', ');
        summaryRow.style.display = 'flex';

        const deleteIcon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`;
        const eyeIcon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>`;
        const dlIcon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>`;

        const html = data.items.map(item => {
          if (item.type === 'folder') {
            const escapedPath = item.path.replace(/'/g, "\\'");
            return `
              <div class="download-item" onclick="loadDownloads('${escapedPath}')">
                <div class="download-icon type-folder">${getFileIconSvg('type-folder')}</div>
                <div class="download-info">
                  <div class="download-name-row">
                    <div class="download-name">${item.name}</div>
                  </div>
                  <div class="download-meta">${item.file_count} file${item.file_count !== 1 ? 's' : ''}</div>
                </div>
                <div class="download-actions">
                  <button class="action-btn delete" onclick="event.stopPropagation(); deleteFile('${escapedPath}')" title="Delete">${deleteIcon}</button>
                </div>
              </div>
            `;
          } else {
            const escapedPath = item.path.replace(/'/g, "\\'");
            const escapedName = item.name.replace(/'/g, "\\'");
            const typeClass = getTypeClass(item.name);
            const parsed = parseReportName(item.name);
            const badge = parsed && parsed.number
              ? `<span class="report-badge">#${parsed.number}</span>`
              : '';
            const displayName = parsed
              ? parsed.name
              : item.name.replace(/\.[^.]+$/, '');
            const metaTime = item.modified ? relativeTime(item.modified) : '';
            const metaSize = formatFileSize(item.size);
            return `
              <div class="download-item">
                <div class="download-icon ${typeClass}">${getFileIconSvg(typeClass)}</div>
                <div class="download-info">
                  <div class="download-name-row">
                    ${badge}
                    <div class="download-name-link" onclick="openPreview('${escapedPath}', '${escapedName}')" title="${item.name}">${displayName}</div>
                  </div>
                  <div class="download-meta">
                    <span>${metaSize}</span>
                    ${metaTime ? `<span class="download-meta-sep"></span><span>${metaTime}</span>` : ''}
                  </div>
                </div>
                <div class="download-actions">
                  <button class="action-btn" onclick="openPreview('${escapedPath}', '${escapedName}')" title="Preview">${eyeIcon}</button>
                  <a class="action-btn" href="/api/downloads/view/${item.path}" download="${item.name}" title="Download">${dlIcon}</a>
                  <button class="action-btn delete" onclick="deleteFile('${escapedPath}')" title="Delete">${deleteIcon}</button>
                </div>
              </div>
            `;
          }
        }).join('');

        list.innerHTML = html;
      } catch (error) {
        console.error('Failed to load downloads:', error);
        document.getElementById('downloadsList').innerHTML = '<div class="downloads-empty">Failed to load</div>';
      }
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    function viewFile(filePath, fileName) {
      if (!fileName) {
        fileName = filePath.split('/').pop();
      }
      openPreview(filePath, fileName);
    }

    function closePreview() {
      const overlay = document.getElementById('previewOverlay');
      const body = document.getElementById('previewBody');
      overlay.classList.remove('active');
      body.innerHTML = '';
    }

    async function deleteFile(filePath) {
      if (!confirm(`Delete "${filePath}"?`)) return;

      try {
        const response = await fetch(`/api/downloads/${encodeURIComponent(filePath)}`, { method: 'DELETE' });
        const result = await response.json();
        if (result.success) {
          loadDownloads(currentDownloadPath);
        } else {
          alert(`Failed to delete: ${result.error}`);
        }
      } catch (error) {
        console.error('Failed to delete:', error);
      }
    }

    async function clearAllDownloads() {
      if (!confirm('Clear all downloaded files? This cannot be undone.')) return;
      try {
        const response = await fetch('/api/downloads', { method: 'DELETE' });
        const result = await response.json();
        if (result.success) {
          loadDownloads('');
        } else {
          alert(`Failed to clear: ${result.error}`);
        }
      } catch (error) {
        console.error('Failed to clear downloads:', error);
      }
    }

    function downloadAllAsZip() {
      window.open('/api/downloads/zip', '_blank');
    }

    async function openPreview(filePath, fileName) {
      const ext = fileName.split('.').pop().toLowerCase();
      if (ext === 'xlsx' || ext === 'xls') {
        await openExcelPreview(filePath, fileName);
        return;
      }
      const overlay = document.getElementById('previewOverlay');
      const body = document.getElementById('previewBody');
      const nameEl = document.getElementById('previewFileName');
      const downloadBtn = document.getElementById('previewDownloadBtn');
      const fileUrl = `/api/downloads/view/${encodeURIComponent(filePath)}`;

      nameEl.textContent = fileName;
      downloadBtn.onclick = () => window.open(fileUrl, '_blank');
      body.innerHTML = '';

      if (ext === 'html' || ext === 'pdf') {
        const iframe = document.createElement('iframe');
        iframe.src = fileUrl;
        body.appendChild(iframe);
      } else if (['png', 'jpg', 'jpeg', 'gif', 'svg'].includes(ext)) {
        const img = document.createElement('img');
        img.src = fileUrl;
        img.alt = fileName;
        body.appendChild(img);
      } else {
        body.innerHTML = `
          <div class="preview-no-preview">
            <div class="preview-no-preview-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
              </svg>
            </div>
            <p>No preview available</p>
            <span>${fileName}</span>
          </div>
        `;
      }
      overlay.classList.add('active');
    }

    async function openExcelPreview(filePath, fileName) {
      const overlay = document.getElementById('previewOverlay');
      const body = document.getElementById('previewBody');
      const nameEl = document.getElementById('previewFileName');
      const downloadBtn = document.getElementById('previewDownloadBtn');
      const fileUrl = `/api/downloads/view/${encodeURIComponent(filePath)}`;

      nameEl.textContent = fileName;
      downloadBtn.onclick = () => window.open(fileUrl, '_blank');
      body.innerHTML = '<div style="padding:40px;color:var(--text-muted);">Loading spreadsheet...</div>';
      overlay.classList.add('active');

      try {
        const response = await fetch(`/api/downloads/preview/${encodeURIComponent(filePath)}`);
        const data = await response.json();
        if (data.error) {
          body.innerHTML = `<div class="preview-no-preview"><p>${data.error}</p></div>`;
          return;
        }

        const sheetNames = Object.keys(data.sheets);
        let html = '';
        if (sheetNames.length > 1) {
          html += '<div class="excel-sheet-tabs" id="excelSheetTabs">';
          sheetNames.forEach((name, i) => {
            html += `<button class="excel-sheet-tab ${i === 0 ? 'active' : ''}" onclick="switchExcelSheet('${name.replace(/'/g, "\\'")}')">${name}</button>`;
          });
          html += '</div>';
        }
        html += '<div id="excelSheetContent" style="flex:1;overflow:auto;"></div>';
        body.innerHTML = html;
        body.style.flexDirection = 'column';
        body.style.alignItems = 'stretch';
        window._excelSheets = data.sheets;
        switchExcelSheet(sheetNames[0]);
      } catch (err) {
        body.innerHTML = `<div class="preview-no-preview"><p>Failed to load preview</p></div>`;
      }
    }

    function switchExcelSheet(sheetName) {
      const rows = window._excelSheets[sheetName];
      if (!rows || rows.length === 0) {
        document.getElementById('excelSheetContent').innerHTML = '<div style="padding:20px;color:var(--text-muted);">Empty sheet</div>';
        return;
      }
      document.querySelectorAll('.excel-sheet-tab').forEach(tab => {
        tab.classList.toggle('active', tab.textContent === sheetName);
      });
      let tableHtml = '<table class="excel-preview-table"><thead><tr>';
      rows[0].forEach(cell => { tableHtml += `<th>${cell}</th>`; });
      tableHtml += '</tr></thead><tbody>';
      for (let i = 1; i < rows.length; i++) {
        tableHtml += '<tr>';
        rows[i].forEach(cell => { tableHtml += `<td title="${cell}">${cell}</td>`; });
        tableHtml += '</tr>';
      }
      tableHtml += '</tbody></table>';
      document.getElementById('excelSheetContent').innerHTML = tableHtml;
    }

    // Drag and drop for upload
    const uploadZone = document.getElementById('uploadZone');

    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', () => {
      uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file) {
        document.getElementById('fileInput').files = e.dataTransfer.files;
        handleFileUpload({ target: { files: [file] } });
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closePreview();
        closeFullscreen();
      }
    });

    // Credentials Management
    let credentialsConfigured = false;

    async function checkCredentials() {
      try {
        const response = await fetch('/api/credentials/check');
        if (!response.ok) throw new Error(`Server error: ${response.status}`);
        const data = await response.json();
        credentialsConfigured = data.configured;

        if (data.email) {
          document.getElementById('xeroEmail').value = data.email;
        }

        if (!data.configured) {
          showSetupModal();
        }
        return data.configured;
      } catch (error) {
        console.error('Failed to check credentials:', error);
        return false;
      }
    }

    async function showSetupModal() {
      if (credentialsConfigured) {
        const response = await fetch('/api/credentials/check');
        if (response.ok) {
          const data = await response.json();
          if (data.email) {
            document.getElementById('xeroEmail').value = data.email;
          }
        }
      }
      document.getElementById('xeroPassword').value = '';
      document.getElementById('setupError').classList.remove('visible');
      document.getElementById('setupModal').classList.add('active');
    }

    function hideSetupModal() {
      document.getElementById('setupModal').classList.remove('active');
    }

    async function saveCredentials(event) {
      event.preventDefault();

      const email = document.getElementById('xeroEmail').value.trim();
      const password = document.getElementById('xeroPassword').value;
      const errorEl = document.getElementById('setupError');
      const btn = document.getElementById('saveCredentialsBtn');

      if (!email || !password) {
        errorEl.textContent = 'Please fill in both email and password';
        errorEl.classList.add('visible');
        return;
      }

      btn.disabled = true;
      btn.innerHTML = `
        <div class="loading-spinner" style="width: 18px; height: 18px; border-width: 2px;"></div>
        Saving...
      `;

      try {
        const response = await fetch('/api/credentials/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        if (!response.ok) {
          throw new Error(`Server error: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();

        if (data.success) {
          hideSetupModal();
          addActivityCard({
            type: 'log',
            level: 'success',
            message: `Credentials saved for ${data.email}`,
            timestamp: new Date().toLocaleTimeString()
          });
        } else {
          throw new Error(data.error || 'Failed to save credentials');
        }
      } catch (error) {
        errorEl.textContent = error.message;
        errorEl.classList.add('visible');
      } finally {
        btn.disabled = false;
        btn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
            <polyline points="17 21 17 13 7 13 7 21"></polyline>
            <polyline points="7 3 7 8 15 8"></polyline>
          </svg>
          Save & Continue
        `;
      }
    }

    // Right Panel Resize
    (function() {
      const handle = document.getElementById('resizeHandle');
      const main = document.querySelector('.main');
      let isDragging = false;
      let startX, startWidth;

      handle.addEventListener('mousedown', (e) => {
        isDragging = true;
        startX = e.clientX;
        const rightPanel = document.getElementById('rightPanel');
        startWidth = rightPanel.getBoundingClientRect().width;
        handle.classList.add('dragging');
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';

        const frames = main.querySelectorAll('img, iframe');
        frames.forEach(f => f.style.pointerEvents = 'none');
      });

      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const dx = startX - e.clientX;
        const newWidth = Math.min(600, Math.max(280, startWidth + dx));
        main.style.gridTemplateColumns = `320px 1fr 6px ${newWidth}px`;
      });

      document.addEventListener('mouseup', () => {
        if (!isDragging) return;
        isDragging = false;
        handle.classList.remove('dragging');
        document.body.style.cursor = '';
        document.body.style.userSelect = '';

        const frames = main.querySelectorAll('img, iframe');
        frames.forEach(f => f.style.pointerEvents = '');
      });
    })();

    async function loadDefaultClients() {
      try {
        const response = await fetch('/api/default-clients');
        const data = await response.json();
        if (data.clients && data.clients.length > 0) {
          clients = data.clients;
          renderClients();
          document.getElementById('uploadZone').style.display = 'none';
          document.getElementById('fileLoaded').style.display = 'flex';
          document.getElementById('fileName').textContent = data.filename + ' (default)';
          document.getElementById('startBtn').disabled = false;
        }
      } catch (e) {
        console.log('No default clients available');
      }
    }

    // Initialize
    checkCredentials();
    connect();
    loadDefaultClients();
  </script>
</body>
</html>
